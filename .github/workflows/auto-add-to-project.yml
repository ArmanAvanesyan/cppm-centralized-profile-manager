name: "Auto Add Issues to Project & Assign Type"

on:
  issues:
    types:
      - opened
      - edited

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    steps:
      - name: Get Project ID
        id: get_project_id
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROJECT_ID=$(gh api graphql -f query='
            query {
              repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                projectsV2(first: 5) {
                  nodes { id, title }
                }
              }
            }' | jq -r '.data.repository.projectsV2.nodes[0].id')
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
          echo "‚úÖ Fetched Project ID: $PROJECT_ID"

      - name: Add Issue to GitHub Project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const projectId = process.env.PROJECT_ID;  
            const issueNodeId = context.payload.issue.node_id;

            if (!projectId || !issueNodeId) {
              console.error("üö® Missing Project ID or Issue Node ID");
              return;
            }

            console.log(`üîπ Adding issue ${context.payload.issue.number} to project...`);

            const mutation = `
              mutation {
                addProjectV2ItemById(input: { projectId: "${projectId}", contentId: "${issueNodeId}" }) {
                  item { id }
                }
              }
            `;

            try {
              const response = await github.graphql(mutation);
              console.log("‚úÖ Issue successfully added:", response);
            } catch (error) {
              console.error("‚ùå Failed to add issue:", error);
            }
